{"version":3,"sources":["../src/plugin.svelte.ts"],"sourcesContent":["import type { Plugin } from 'vite'\r\nimport { mergeConfig } from 'vite'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport { colorSuitePlugin as colorSuiteVitePlugin } from './plugin.vite'\r\nimport { COLOR_SUITE_PATH, COLOR_CONFIG_ID, DEFAULT_COLOR_CONFIG, EDITOR_APP_MOUNT_ID, SETTINGS_CONFIG_ID, COLOR_SUITE_ID, RESOLVED_COLORS_ID, PREFIXED_COLOR_CONFIG_ID, PREFIXED_SETTINGS_CONFIG_ID, PREFIXED_RESOLVED_COLORS_ID, SETTINGS_UPDATED_EVENT } from './constants';\r\n\r\n// taken from /@sveltejs/kit/src/utils/filesystem.js\r\nfunction resolve_entry(entry: string) {\r\n\tif (fs.existsSync(entry)) {\r\n\t\tconst stats = fs.statSync(entry);\r\n\t\tconst index = path.join(entry, 'index');\r\n\t\tif (stats.isDirectory() && fs.existsSync(index)) {\r\n\t\t\treturn resolve_entry(index);\r\n\t\t}\r\n\t\treturn entry;\r\n\t} else {\r\n\t\tconst dir = path.dirname(entry);\r\n\t\tif (fs.existsSync(dir)) {\r\n\t\t\tconst base = path.basename(entry);\r\n\t\t\tconst files = fs.readdirSync(dir);\r\n\t\t\tconst found = files.find((file) => file.replace(/\\.(js|ts)$/, '') === base);\r\n\t\t\tif (found) return path.join(dir, found);\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nexport function colorSuiteSvelteConfig<Config extends Record<string, any>>(svelteKitConfig?: Config): Config {\r\n\tconst outDir = svelteKitConfig?.kit?.outDir ?? '.svelte-kit'\r\n\tconst currentHook = `${outDir}/generated/colorsuite-hook.server.mjs`\r\n\tconst previousHook = svelteKitConfig?.kit?.files?.hooks?.server ?? 'src/hooks.server'\r\n\r\n\tglobalThis.__colorSuiteHook = {\r\n\t\tcurrentHook,\r\n\t\tpreviousHook,\r\n\t}\r\n\r\n\t/** @type {import('@sveltejs/kit').Config} */\r\n\tconst overrides = {\r\n\t\tkit: {\r\n\t\t\tfiles: {\r\n\t\t\t\thooks: {\r\n\t\t\t\t\tserver: currentHook\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\treturn mergeConfig(svelteKitConfig as any ?? {}, overrides) as Config;\r\n}\r\n\r\nfunction hookServerHookPlugin(): Plugin {\r\n\tlet is_build: boolean\r\n\tlet currentHook: string\r\n\tlet previousHook: string | null\r\n\treturn {\r\n\t\tname: 'hook-sveltekit-colorsuite',\r\n\t\tenforce: 'pre',\r\n\r\n\t\tconfig(config, config_env) {\r\n\t\t\tconst hookConfig = (globalThis as any).__colorSuiteHook\r\n\t\t\tif (!hookConfig) {\r\n\t\t\t\tthrow new Error(`[Color Suite] Hook weren't hooked. Did you forget to add colorSuiteSvelteConfig to svelte.config.js ?`)\r\n\t\t\t}\r\n\r\n\t\t\tis_build = config_env.command === 'build'\r\n\t\t\tcurrentHook = path.resolve(hookConfig.currentHook)\r\n\t\t\tpreviousHook = resolve_entry(hookConfig.previousHook)\r\n\t\t\tif (previousHook && fs.existsSync(previousHook)) {\r\n\t\t\t\tconst currentDir = path.dirname(currentHook)\r\n\t\t\t\tpreviousHook = path.relative(currentDir, previousHook).replace(/\\\\/g, '/')\r\n\t\t\t} else {\r\n\t\t\t\tpreviousHook = null\r\n\t\t\t}\r\n\r\n\t\t\tif (is_build) {\r\n\t\t\t\tconst combinedHooksContent = `\r\n\t\t\t\t\t// this file is auto-generated\r\n\t\t\t\t\texport * from ${JSON.stringify(previousHook)};\r\n\t\t\t\t`\r\n\t\t\t\tfs.mkdirSync(path.dirname(currentHook), { recursive: true });\r\n\t\t\t\tfs.writeFileSync(currentHook, combinedHooksContent);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tconfigureServer(server) {\r\n\r\n\t\t\tlet combinedHooksContent\r\n\t\t\tif (previousHook) {\r\n\t\t\t\tcombinedHooksContent = `\r\n\t\t\t\t\timport { sequence } from '@sveltejs/kit/hooks';\r\n\t\t\t\t\timport * as userHooks from ${JSON.stringify(previousHook)};\r\n\t\t\t\t\timport { colorSuiteHandler } from 'tailwindcss-color-suite/svelte';\r\n\t\t\t\t\texport const handle = sequence(colorSuiteHandler, userHooks.handle);\r\n\t\t\t\t\texport default { ...userHooks, handle };\r\n\t\t\t\t`\r\n\t\t\t} else {\r\n\t\t\t\tcombinedHooksContent = `\r\n\t\t\t\t\texport * from 'tailwindcss-color-suite/svelte';\r\n\t\t\t\t`;\r\n\t\t\t}\r\n\t\t\tcombinedHooksContent = `\r\n\t\t\t\t// this file is auto-generated\r\n\t\t\t\t${combinedHooksContent}\r\n\t\t\t`\r\n\r\n\t\t\tfs.mkdirSync(path.dirname(currentHook), { recursive: true })\r\n\t\t\tfs.writeFileSync(currentHook, combinedHooksContent)\r\n\t\t},\r\n\r\n\t};\r\n}\r\n\r\nexport async function colorSuiteHandler ({ event, resolve }) {\r\n\treturn await resolve(event, {\r\n\ttransformPageChunk: async ({ html }) => {\r\n\t\tconst head = `<script type=\"module\" src=\"${COLOR_SUITE_PATH}\"></script>`\r\n\t\tconst body = `<div id=\"${EDITOR_APP_MOUNT_ID}\"></div>`\r\n\t\treturn html\r\n\t\t\t.replace('</head>', head + '</head>')\r\n\t\t\t.replace(/<body(.*?)>/, (match, attributes) => '<body' + attributes + '>' + body);\r\n\t},\r\n});\r\n}\r\n\r\nexport function colorSuitePlugin(options: Parameters<typeof colorSuiteVitePlugin>[0] = {}): Plugin[] {\r\n\treturn [colorSuiteVitePlugin(options), hookServerHookPlugin()];\r\n}"],"mappings":"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","names":["colorSuitePlugin"]}